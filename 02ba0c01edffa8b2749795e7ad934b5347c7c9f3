{
  "comments": [
    {
      "key": {
        "uuid": "5d9154de_aaf39d9c",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 7
      },
      "lineNbr": 0,
      "author": {
        "id": 1290487
      },
      "writtenOn": "2020-08-29T00:12:27Z",
      "side": 1,
      "message": "PTAL ... Ready for review.\n\nI added several tests that look at load/store ops \u0026 did some cleanup/fixes.",
      "revId": "02ba0c01edffa8b2749795e7ad934b5347c7c9f3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "586b845e_058b8e94",
        "filename": "src/libANGLE/renderer/vulkan/vk_helpers.h",
        "patchSetId": 7
      },
      "lineNbr": 872,
      "author": {
        "id": 1329751
      },
      "writtenOn": "2020-08-29T14:00:51Z",
      "side": 1,
      "message": "I don\u0027t know why these sentinel values are necessary - can you sketch out the scenarios you were thinking? I\u0027ll be out so it\u0027s possible we can land this and fix later. I was pretty sure you could determine noLongerInvalidated / etc without needing any more than one sentinel value.",
      "range": {
        "startLine": 868,
        "startChar": 0,
        "endLine": 872,
        "endChar": 49
      },
      "revId": "02ba0c01edffa8b2749795e7ad934b5347c7c9f3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9cf1daf5_37d4f1bc",
        "filename": "src/libANGLE/renderer/vulkan/vk_helpers.h",
        "patchSetId": 7
      },
      "lineNbr": 872,
      "author": {
        "id": 1290487
      },
      "writtenOn": "2020-08-29T21:29:48Z",
      "side": 1,
      "message": "kEnabledCmdCount is \"infinity\" for mDepthCmdCountDisabled.  I used a different name than kNeverInvalidatedCmdCount because I thought it would make the code clearer.  I used a different value to make it clearer in the debugger.  I can eliminate it if you want.\n\n\nI created kNoLongerInvalidatedCmdCount to differentiate the following 2 cases:\n\n- invalidate-disable-draw-enable  (i.e. draw-while-disabled)\n\n- invalidate-draw-disable-enable  (i.e. draw-while-enabled)\n\nScenario 1:\nAction  mDepthCmdCountInvalidated   mDepthCmdCountDisabled   rpCount\n--------------------------------------------------------------------\nDraw        infinity                     infinity               1\nInvalidate  1                            infinity               1\nDisable     1                            1                      1\nDraw        1                            1                      2\nEnable      1                            infinity               2\n\nScenario 2:\nAction  mDepthCmdCountInvalidated   mDepthCmdCountDisabled   rpCount\n--------------------------------------------------------------------\nDraw        infinity                     infinity               1\nInvalidate  1                            infinity               1\nDraw        1                            infinity               2\nDisable     1                            2                      2\nEnable      1                            infinity               2\n\nIn the 1st scenario, the original algorithm thinks draw-while-enabled happened, when really a draw-while-disabled (PUBG case) happened.  My state-based approach taught me the fix: update mDepthCmdCountInvalidated when going from disabled to enabled.  That changes it to:\n\nScenario 1 with first fix:\nAction  mDepthCmdCountInvalidated   mDepthCmdCountDisabled   rpCount\n--------------------------------------------------------------------\nDraw        infinity                     infinity               1\nInvalidate  1                            infinity               1\nDisable     1                            1                      1\nDraw        1                            1                      2\nEnable      1 --\u003e 2                      infinity               2\n\nThat makes it clear that a draw-while-enabled didn\u0027t happen.  If a draw is done after this point, then we know that a draw-while-enabled happened.  However, this fix hurts the 2nd scenario, since it becomes:\n\nScenario 2 with first fix:\nAction  mDepthCmdCountInvalidated   mDepthCmdCountDisabled   rpCount\n--------------------------------------------------------------------\nDraw        infinity                     infinity               1\nInvalidate  1                            infinity               1\nDraw        1                            infinity               2\nDisable     1                            2                      2\nEnable      1 --\u003e 2                      infinity               2\n\nkNoLongerInvalidatedCmdCount ensures that once we catch a draw-while-enabled, we never uncatch it:\n\nScenario 2 with kNoLongerInvalidatedCmdCount fix:\nAction  mDepthCmdCountInvalidated   mDepthCmdCountDisabled   rpCount\n--------------------------------------------------------------------\nDraw        infinity                     infinity               1\nInvalidate  1                            infinity               1\nDraw        1                            infinity               2\nDisable     kNoLongerInvalidatedCmdCount infinity               2\nEnable      kNoLongerInvalidatedCmdCount infinity               2\n\nNo matter how many enables, disables, or draws happen after this point, we know that a draw-while-enabled happened, and that the attachment is no longer invalidated.\n\nDoes that make sense?",
      "parentUuid": "586b845e_058b8e94",
      "range": {
        "startLine": 868,
        "startChar": 0,
        "endLine": 872,
        "endChar": 49
      },
      "revId": "02ba0c01edffa8b2749795e7ad934b5347c7c9f3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1121bf6e_71023e24",
        "filename": "src/libANGLE/renderer/vulkan/vk_helpers.h",
        "patchSetId": 7
      },
      "lineNbr": 872,
      "author": {
        "id": 1329751
      },
      "writtenOn": "2020-08-29T22:30:42Z",
      "side": 1,
      "message": "OK, I get it. Just can you point me to the two test cases that demonstrate this difference?",
      "parentUuid": "9cf1daf5_37d4f1bc",
      "range": {
        "startLine": 868,
        "startChar": 0,
        "endLine": 872,
        "endChar": 49
      },
      "revId": "02ba0c01edffa8b2749795e7ad934b5347c7c9f3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "47da023c_24501a3d",
        "filename": "src/libANGLE/renderer/vulkan/vk_helpers.h",
        "patchSetId": 7
      },
      "lineNbr": 872,
      "author": {
        "id": 1290487
      },
      "writtenOn": "2020-08-30T01:49:09Z",
      "side": 1,
      "message": "Sure.\n\nGet Patchset 9 and look for InvalidateDisableDrawEnable and InvalidateDrawDisableEnable.  Within those tests, look at the 4 lines under the comment that starts \"// Execute the scenario\"",
      "parentUuid": "1121bf6e_71023e24",
      "range": {
        "startLine": 868,
        "startChar": 0,
        "endLine": 872,
        "endChar": 49
      },
      "revId": "02ba0c01edffa8b2749795e7ad934b5347c7c9f3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6e05d165_207c070b",
        "filename": "src/libANGLE/renderer/vulkan/vk_helpers.h",
        "patchSetId": 7
      },
      "lineNbr": 872,
      "author": {
        "id": 1329751
      },
      "writtenOn": "2020-08-30T14:01:25Z",
      "side": 1,
      "message": "Right right. The trick to solving InvalidateDisableDrawEnable/InvalidateDrawDisableEnable is to clear the \"invalidate\" counter on \"enable\". Once you \"enable\" you no longer have a DONT_CARE situation. So we set \"invalidate count\" to infinity.\n\nI don\u0027t recall the details of our conversation Friday or if we came to another conclusion.",
      "parentUuid": "47da023c_24501a3d",
      "range": {
        "startLine": 868,
        "startChar": 0,
        "endLine": 872,
        "endChar": 49
      },
      "revId": "02ba0c01edffa8b2749795e7ad934b5347c7c9f3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f6609f81_69c45c8f",
        "filename": "src/libANGLE/renderer/vulkan/vk_helpers.h",
        "patchSetId": 7
      },
      "lineNbr": 872,
      "author": {
        "id": 1297197
      },
      "writtenOn": "2020-08-31T14:31:36Z",
      "side": 1,
      "message": "It looks like this is getting complicated enough that some version of Ian\u0027s comment should probably go into a .md in doc/ so it can be referenced here.",
      "parentUuid": "6e05d165_207c070b",
      "range": {
        "startLine": 868,
        "startChar": 0,
        "endLine": 872,
        "endChar": 49
      },
      "revId": "02ba0c01edffa8b2749795e7ad934b5347c7c9f3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "39c970fb_8043063a",
        "filename": "src/libANGLE/renderer/vulkan/vk_helpers.h",
        "patchSetId": 7
      },
      "lineNbr": 872,
      "author": {
        "id": 1290487
      },
      "writtenOn": "2020-08-31T18:24:08Z",
      "side": 1,
      "message": "\u003e The trick to solving InvalidateDisableDrawEnable/InvalidateDrawDisableEnable is to clear the \"invalidate\" counter on \"enable\".\n\nThat undoes all knowledge that the attachment was invalidated, and thus we won\u0027t restore mContentDefined to true (i.e. the next RP won\u0027t LOAD the attachment).\n\n\u003e It looks like this is getting complicated enough that some version of Ian\u0027s comment should probably go into a .md in doc/ so it can be referenced here.\n\nI\u0027ve been putting things in the design doc.  A .md file probably makes sense (or a pointer to the design doc).",
      "parentUuid": "f6609f81_69c45c8f",
      "range": {
        "startLine": 868,
        "startChar": 0,
        "endLine": 872,
        "endChar": 49
      },
      "revId": "02ba0c01edffa8b2749795e7ad934b5347c7c9f3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ee63a28b_87ebb2d3",
        "filename": "src/libANGLE/renderer/vulkan/vk_helpers.h",
        "patchSetId": 7
      },
      "lineNbr": 872,
      "author": {
        "id": 1329751
      },
      "writtenOn": "2020-08-31T22:55:09Z",
      "side": 1,
      "message": "If there was a depth enabled draw, we *should* undo all knowledge that the attachment was invalidated. That\u0027s correct and necessary because depth values are now defined. So the RP should LOAD and not DONT_CARE for the load op.\n\nIs there a counterexample situation you are worried about?",
      "parentUuid": "39c970fb_8043063a",
      "range": {
        "startLine": 868,
        "startChar": 0,
        "endLine": 872,
        "endChar": 49
      },
      "revId": "02ba0c01edffa8b2749795e7ad934b5347c7c9f3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "8caea642_674be912",
        "filename": "src/libANGLE/renderer/vulkan/vk_helpers.h",
        "patchSetId": 7
      },
      "lineNbr": 872,
      "author": {
        "id": 1290487
      },
      "writtenOn": "2020-08-31T23:41:43Z",
      "side": 1,
      "message": "I\u0027d like to make sure we\u0027re talking about the same thing ... I uploaded a CL (crrev/c/2386576) that does what I think you are asking for.  Did I understand and implement your suggestion correctly?\n\nThe CL breaks 3 tests, as I would expect.  This is because mContentDefined isn\u0027t set to true at endRP.  The CL builds on top of two CLs:\n\n- This CL.  I fixed some test issues this morning and added code to test the load ops of the following RP\n\n- crrev/c/2386478.  That CL moves mContentDefined to ImageHelper and  sets mContentDefined  at endRP).",
      "parentUuid": "ee63a28b_87ebb2d3",
      "range": {
        "startLine": 868,
        "startChar": 0,
        "endLine": 872,
        "endChar": 49
      },
      "revId": "02ba0c01edffa8b2749795e7ad934b5347c7c9f3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "d6d3aaef_5cdc2df5",
        "filename": "src/libANGLE/renderer/vulkan/vk_helpers.h",
        "patchSetId": 7
      },
      "lineNbr": 1072,
      "author": {
        "id": 1329751
      },
      "writtenOn": "2020-08-29T14:00:51Z",
      "side": 1,
      "message": "nit: static methods are caps, regular lower case, please see the ANGLE style guide.",
      "range": {
        "startLine": 1072,
        "startChar": 9,
        "endLine": 1072,
        "endChar": 29
      },
      "revId": "02ba0c01edffa8b2749795e7ad934b5347c7c9f3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5064d041_f22240a0",
        "filename": "src/libANGLE/renderer/vulkan/vk_helpers.h",
        "patchSetId": 7
      },
      "lineNbr": 1072,
      "author": {
        "id": 1290487
      },
      "writtenOn": "2020-08-29T21:29:48Z",
      "side": 1,
      "message": "Oops, that\u0027s actually a typo (didn\u0027t mean to capitalize that).  Fixed.",
      "parentUuid": "d6d3aaef_5cdc2df5",
      "range": {
        "startLine": 1072,
        "startChar": 9,
        "endLine": 1072,
        "endChar": 29
      },
      "revId": "02ba0c01edffa8b2749795e7ad934b5347c7c9f3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "66eb4193_010d752f",
        "filename": "src/tests/gl_tests/VulkanPerformanceCounterTest.cpp",
        "patchSetId": 7
      },
      "lineNbr": 1052,
      "author": {
        "id": 1329751
      },
      "writtenOn": "2020-08-29T14:00:51Z",
      "side": 1,
      "message": "can you condense these new tests into some way to share code?",
      "range": {
        "startLine": 1052,
        "startChar": 37,
        "endLine": 1052,
        "endChar": 64
      },
      "revId": "02ba0c01edffa8b2749795e7ad934b5347c7c9f3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e4dcd76d_81d729a7",
        "filename": "src/tests/gl_tests/VulkanPerformanceCounterTest.cpp",
        "patchSetId": 7
      },
      "lineNbr": 1052,
      "author": {
        "id": 1290487
      },
      "writtenOn": "2020-08-29T21:29:48Z",
      "side": 1,
      "message": "Sure, I\u0027ll do that on Monday.  I was so excited that I could test all of these combinations that I got carried away:-).",
      "parentUuid": "66eb4193_010d752f",
      "range": {
        "startLine": 1052,
        "startChar": 37,
        "endLine": 1052,
        "endChar": 64
      },
      "revId": "02ba0c01edffa8b2749795e7ad934b5347c7c9f3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ca486acf_f3e5528d",
        "filename": "src/tests/gl_tests/VulkanPerformanceCounterTest.cpp",
        "patchSetId": 7
      },
      "lineNbr": 1052,
      "author": {
        "id": 1290487
      },
      "writtenOn": "2020-08-30T01:49:09Z",
      "side": 1,
      "message": "Done (I did it now to make it easier for your review)",
      "parentUuid": "e4dcd76d_81d729a7",
      "range": {
        "startLine": 1052,
        "startChar": 37,
        "endLine": 1052,
        "endChar": 64
      },
      "revId": "02ba0c01edffa8b2749795e7ad934b5347c7c9f3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}