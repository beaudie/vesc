{
  "comments": [
    {
      "key": {
        "uuid": "397dea43_66432b37",
        "filename": "src/libANGLE/Program.cpp",
        "patchSetId": 19
      },
      "lineNbr": 1627,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2020-05-09T01:38:54Z",
      "side": 1,
      "message": "I took a cursory glance, and this is the part I don\u0027t like. Basically ProgramExecutable is permanently keeping a duplicate of the linked state, am I right?\n\nThat\u0027s just wasted memory. So instead of:\n\n    clearState();\n    linkIntoState();\n    if (success)\n        saveState();\n\nI suggest this:\n\n    linkIntoTemp();\n    if (success)\n        clearState();\n        moveTempIntoState();\n\nWhich means the same amount of memory is used as before, except it\u0027s doubled during link only. At the same time, the end result is a \"move\" from the temp to state instead of \"copy\".\n\n(It\u0027s possible I misunderstood something, I didn\u0027t look too deeply)",
      "revId": "c58c30a31fa41c31ef1560bb1388ffe9bd51ce62",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ec56fd45_294b19f6",
        "filename": "src/libANGLE/Program.cpp",
        "patchSetId": 19
      },
      "lineNbr": 1627,
      "author": {
        "id": 1329751
      },
      "writtenOn": "2020-05-11T19:03:13Z",
      "side": 1,
      "message": "I\u0027m not super enthusiastic about trying to save memory when linking. Is there a more fundamental concern? Not sure I fully understand your idea either.",
      "parentUuid": "397dea43_66432b37",
      "revId": "c58c30a31fa41c31ef1560bb1388ffe9bd51ce62",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "643fa33b_5bb6fea8",
        "filename": "src/libANGLE/Program.cpp",
        "patchSetId": 19
      },
      "lineNbr": 1627,
      "author": {
        "id": 1297197
      },
      "writtenOn": "2020-05-12T01:01:32Z",
      "side": 1,
      "message": "With the latest change, rather than the full ShaderState being saved, it\u0027s just the vectors of input and output varyings for each stage (along with versions), so I think this should be a minimal impact - especially with the addition of only doing it for separable programs.\n\nDoes that work for you Shabi?",
      "parentUuid": "ec56fd45_294b19f6",
      "revId": "c58c30a31fa41c31ef1560bb1388ffe9bd51ce62",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "284efa1d_143fac50",
        "filename": "src/libANGLE/Program.cpp",
        "patchSetId": 19
      },
      "lineNbr": 1627,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2020-05-12T03:11:03Z",
      "side": 1,
      "message": "@Jamie, it\u0027s not about saving memory during link. Current implementation increases memory footprint by saving duplicate information permanently. My suggestion is in fact to increase memory usage during link, to avoid having to increase it afterwards.\n\n@Tim, it\u0027s better, sure, but it\u0027s still a waste. ShaderVar is not exactly a small struct. But if it\u0027s too much work to fix it, I\u0027m not blocking the change!",
      "parentUuid": "643fa33b_5bb6fea8",
      "revId": "c58c30a31fa41c31ef1560bb1388ffe9bd51ce62",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b5532940_8ce6b206",
        "filename": "src/libANGLE/Program.cpp",
        "patchSetId": 19
      },
      "lineNbr": 1627,
      "author": {
        "id": 1329751
      },
      "writtenOn": "2020-05-12T15:23:20Z",
      "side": 1,
      "message": "Tim: the shader state part is better. I now see what Shabi was objecting about: having two ProgramExecutables in ProgramState. I agree we should get rid of one of them. Can you put the temporary one in LinkingState? Other ideas welcome.",
      "parentUuid": "284efa1d_143fac50",
      "revId": "c58c30a31fa41c31ef1560bb1388ffe9bd51ce62",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2ca4057d_71332580",
        "filename": "src/libANGLE/Program.cpp",
        "patchSetId": 19
      },
      "lineNbr": 1627,
      "author": {
        "id": 1297197
      },
      "writtenOn": "2020-05-13T01:34:09Z",
      "side": 1,
      "message": "Take a look at the link/linkImpl() changes (I forgot to add that back in after fixing another bug).   This makes it so there is always just a single ProgramExecutable, except when we are doing a linkProgram().   At the end of a link:\n\n- if successful:\n  - mState.mLinkedExecutable \u003d mState.mExecutable\n    - this deletes the old mLinkedExecutable ProgramExecutable, so we only have the new (successfully linked) ProgramExecutable\n- if failed (well, actually always done in link()):\n  - mState.mExecutable \u003d mState.mLinkedExecutable (if mLinkedExecutable !\u003d null)\n    - This deletes the temporarily created ProgramExecutable that failed to link\n    - This is actually always done at the end of link(), but if the link succeeded, mState.mExecutable is already pointing to mState.mLinkedExecutable, so it\u0027s a no-op.\n\nThe only extra memory that\u0027s being consumed now outside of linkProgram() is the input/output varyings and versions for each shader stage.",
      "parentUuid": "b5532940_8ce6b206",
      "revId": "c58c30a31fa41c31ef1560bb1388ffe9bd51ce62",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4823b48b_b584c672",
        "filename": "src/libANGLE/ProgramExecutable.h",
        "patchSetId": 19
      },
      "lineNbr": 353,
      "author": {
        "id": 1329751
      },
      "writtenOn": "2020-05-11T18:56:28Z",
      "side": 1,
      "message": "Let\u0027s try to get rid of this and store the information you need in here instead of the ShaderState class itself.",
      "range": {
        "startLine": 353,
        "startChar": 14,
        "endLine": 353,
        "endChar": 25
      },
      "revId": "c58c30a31fa41c31ef1560bb1388ffe9bd51ce62",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3d915a78_ba1a7a02",
        "filename": "src/libANGLE/ProgramExecutable.h",
        "patchSetId": 19
      },
      "lineNbr": 353,
      "author": {
        "id": 1297197
      },
      "writtenOn": "2020-05-12T01:01:32Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "4823b48b_b584c672",
      "range": {
        "startLine": 353,
        "startChar": 14,
        "endLine": 353,
        "endChar": 25
      },
      "revId": "c58c30a31fa41c31ef1560bb1388ffe9bd51ce62",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}