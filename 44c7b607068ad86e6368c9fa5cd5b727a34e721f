{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "6ae43556_409ccfd1",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 12
      },
      "lineNbr": 0,
      "author": {
        "id": 1105344
      },
      "writtenOn": "2022-06-15T01:11:29Z",
      "side": 1,
      "message": "lgtm with one question.\n",
      "revId": "44c7b607068ad86e6368c9fa5cd5b727a34e721f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "1a50f020_5f393439",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 12
      },
      "lineNbr": 0,
      "author": {
        "id": 1105344
      },
      "writtenOn": "2022-06-15T23:17:18Z",
      "side": 1,
      "message": "+sunnyps for comment on the GPU scheduler\n",
      "revId": "44c7b607068ad86e6368c9fa5cd5b727a34e721f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4e7d4369_6638f7d0",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 12
      },
      "lineNbr": 0,
      "author": {
        "id": 1105284
      },
      "writtenOn": "2022-06-16T18:26:38Z",
      "side": 1,
      "message": "LGTM and agree that the way that Chrome passes cmds to ANGLE can be greatly improved for GPU perf.",
      "revId": "44c7b607068ad86e6368c9fa5cd5b727a34e721f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0a3e4ef9_7ac18fba",
        "filename": "src/tests/gl_tests/PixelLocalStorageTest.cpp",
        "patchSetId": 12
      },
      "lineNbr": 1522,
      "author": {
        "id": 1105344
      },
      "writtenOn": "2022-06-15T01:11:29Z",
      "side": 1,
      "message": "Out of curiosity what would happen if a different context were made current at this point and work were done on it? In Chrome, it\u0027s common for WebGL contexts to be preempted at arbitrary points. If a real pixel local storage extension were in use would this preemption need to be halted in between glBeginPixelLocalStorageANGLE / glEndPixelLocalStorageANGLE calls because otherwise memoryless textures\u0027 contents would be lost?",
      "revId": "44c7b607068ad86e6368c9fa5cd5b727a34e721f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "679b058d_bde39f9b",
        "filename": "src/tests/gl_tests/PixelLocalStorageTest.cpp",
        "patchSetId": 12
      },
      "lineNbr": 1522,
      "author": {
        "id": 1543967
      },
      "writtenOn": "2022-06-15T01:27:36Z",
      "side": 1,
      "message": "That\u0027s a really good question that I don\u0027t know the answer to. I don\u0027t see mention of context preemption in the original PLS spec:\n\nhttps://www.khronos.org/registry/OpenGL/extensions/EXT/EXT_shader_pixel_local_storage.txt\n\nFirst of all, I think that switching contexts in the middle of a PLS render pass doesn\u0027t mean that the render pass is actually active on the GPU yet. Also, \nVulkan uses the word \"transient\" instead of \"memoryless\" for this type of thing: https://gpuopen.com/learn/vulkan-renderpasses/\n\n\"the data in the attachments only lives within the renderpass and never needs to be written to main memory. Although weâ€™ll still allocate memory for such an attachment, the data may never leave the GPU\"\n\nSo I assume that the goal of transient memory is to keep the data on-chip, but to have somewhere to dump to in the unfortunate event that the GPU needs to flush. I also assume that Metal \"memoryless\" attachments and PLS work the same way, just less explicitly.\n\nTL;DR, I think it\u0027s ok, but we will have to test to make sure.",
      "parentUuid": "0a3e4ef9_7ac18fba",
      "revId": "44c7b607068ad86e6368c9fa5cd5b727a34e721f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "20551039_f08a0997",
        "filename": "src/tests/gl_tests/PixelLocalStorageTest.cpp",
        "patchSetId": 12
      },
      "lineNbr": 1522,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2022-06-15T02:18:15Z",
      "side": 1,
      "message": "@Ken, please enlighten me, why are there preemptions? Actually I have specific questions:\n\n1. Does the GPU process use one global context, or one context per WebGL context?\n2. If single context, do the WebGL commands from different sources get interleaved (with state switch, perhaps?)?\n3. If multiple contexts, does eglMakeCurrent happen often, especially in the middle of frame?\n\nPotential problems with PLS aside, preemptions in the middle of render passes will have a disastrous effect on performance on mobile. If that\u0027s how Chrome works, we should probably revisit that.",
      "parentUuid": "679b058d_bde39f9b",
      "revId": "44c7b607068ad86e6368c9fa5cd5b727a34e721f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0840e375_b307ddfa",
        "filename": "src/tests/gl_tests/PixelLocalStorageTest.cpp",
        "patchSetId": 12
      },
      "lineNbr": 1522,
      "author": {
        "id": 1105344
      },
      "writtenOn": "2022-06-15T23:17:18Z",
      "side": 1,
      "message": "The preemptions happen every 20 commands here:\nhttps://source.chromium.org/chromium/chromium/src/+/main:gpu/command_buffer/service/command_buffer_service.cc;l\u003d193;drc\u003dc673ac8876330a42eed34e298ff585636af113bc;bpv\u003d1;bpt\u003d1\n\nIn the current state of Chrome with out-of-process rasterization, out-of-process 2D canvas launching everywhere, and with WebGL being the last client of the GLES2 commands in the renderer process - I\u0027m not sure how much of Chrome\u0027s rendering this preemption applies to. sunnyps@, who wrote the GPU scheduler, will know more.\n\nTo answer these questions:\n\n1) One context per WebGL context.\n2) ANGLE handles this multiplexing by switching among multiple EGL contexts on the client side.\n3) Yes.\n\nIt\u0027s quite possible that Chrome\u0027s rendering code is highly optimized and that WebGL use cases have been pessimmized. Some of these were deliberate design decisions, for example to try to prevent WebGL from interfering with the browser\u0027s UI or other web page rendering.\n\nIf more concerns - feel free to file a Chromium-side bug so the discussion\u0027s in a more archived place than this comment thread of this CL.",
      "parentUuid": "20551039_f08a0997",
      "revId": "44c7b607068ad86e6368c9fa5cd5b727a34e721f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "dba37ded_e710adeb",
        "filename": "src/tests/gl_tests/PixelLocalStorageTest.cpp",
        "patchSetId": 12
      },
      "lineNbr": 1522,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2022-06-16T14:53:50Z",
      "side": 1,
      "message": "Done, crbug.com/1336981",
      "parentUuid": "0840e375_b307ddfa",
      "revId": "44c7b607068ad86e6368c9fa5cd5b727a34e721f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "79af49a4_56e69697",
        "filename": "src/tests/gl_tests/PixelLocalStorageTest.cpp",
        "patchSetId": 12
      },
      "lineNbr": 1522,
      "author": {
        "id": 1543967
      },
      "writtenOn": "2022-06-22T18:39:43Z",
      "side": 1,
      "message": "Marking done. We will follow up on the above bug (which does not appear to be visible publicly).",
      "parentUuid": "dba37ded_e710adeb",
      "revId": "44c7b607068ad86e6368c9fa5cd5b727a34e721f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "0312ea7e_79add667",
        "filename": "src/tests/gl_tests/PixelLocalStorageTest.cpp",
        "patchSetId": 12
      },
      "lineNbr": 1522,
      "author": {
        "id": 1105344
      },
      "writtenOn": "2022-06-25T00:24:49Z",
      "side": 1,
      "message": "Thanks for the heads up - fixed visibility of crbug.com/1336981 .",
      "parentUuid": "79af49a4_56e69697",
      "revId": "44c7b607068ad86e6368c9fa5cd5b727a34e721f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}