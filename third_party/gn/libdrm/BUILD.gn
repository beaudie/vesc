# Copyright 2016 The Chromium Authors
# Copyright 2023 The ANGLE Project Authors
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.
import("../../../gni/angle.gni")

assert(is_linux || is_chromeos)

libdrm_src = "$angle_root/third_party/libdrm"

generated_static_table_fourcc_file =
    "$target_gen_dir/src/generated_static_table_fourcc.h"
fourcc_file = "$libdrm_src/include/drm/drm_fourcc.h"

action("make_generated_static_table_fourcc") {
  script = "$libdrm_src/gen_table_fourcc.py"
  args = [
    rebase_path(fourcc_file, root_build_dir),
    rebase_path(generated_static_table_fourcc_file),
  ]
  outputs = [ generated_static_table_fourcc_file ]
  inputs = [ fourcc_file ]
}

config("libdrm_config") {
  include_dirs = [
    "$libdrm_src",
    "$libdrm_src/include",
    "$libdrm_src/include/drm",
  ]

  # glibc version >= 2.25 explicitly include <sys/sysmacros.h>
  cflags = [ "-DMAJOR_IN_SYSMACROS=1" ]
}

static_library("libdrm") {
  sources = [
    "$libdrm_src/xf86drm.c",
    "$libdrm_src/xf86drmHash.c",
    "$libdrm_src/xf86drmMode.c",
    "$libdrm_src/xf86drmRandom.c",
  ]

  deps = [ ":make_generated_static_table_fourcc" ]

  include_dirs = [
    get_path_info(generated_static_table_fourcc_file, "dir"),
    "$libdrm_src",
    "$libdrm_src/include",
  ]
  configs -= [ "//build/config/compiler:chromium_code" ]
  configs += [ "//build/config/compiler:no_chromium_code" ]

  public_configs = [ ":libdrm_config" ]
}
