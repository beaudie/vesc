{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "d776bcf6_a234c9c3",
        "filename": "src/libANGLE/renderer/vulkan/SurfaceVk.cpp",
        "patchSetId": 9
      },
      "lineNbr": 3186,
      "author": {
        "id": 1564492
      },
      "writtenOn": "2024-08-30T09:40:58Z",
      "side": 1,
      "message": "@syoussefi@chromium.org\n\nI\u0027m not sure what method (`postProcessUnlockedTryAcquire()` or `doDeferredAcquireNextImage()`) should be used here as well as in the `swapImpl()`.\n\nIn my understanding, `prepareSwap()` is technically optional. All other methods should still work even if `prepareSwap()` is not called.\n\nIf `swapImpl()` is mandatory, then need to keep `postProcessUnlockedTryAcquire()` here and also update `swapImpl()` to match it.\n\nAdditional note: in this change I returned use of `angle::ToEGL()` instead of directly returning `egl::EglBadSurface()`. In my understanding, this is the correct way when error was caused by Vulkan API.",
      "revId": "cfffd82485b6d4065fba57273fa5f89b843653db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a2e14019_7421eb23",
        "filename": "src/libANGLE/renderer/vulkan/SurfaceVk.cpp",
        "patchSetId": 9
      },
      "lineNbr": 3186,
      "author": {
        "id": 1564492
      },
      "writtenOn": "2024-08-30T13:04:27Z",
      "side": 1,
      "message": "\u003e If swapImpl() is mandatory,\n\n**edit:** If `prepareSwap()` is mandatory, ...",
      "parentUuid": "d776bcf6_a234c9c3",
      "revId": "cfffd82485b6d4065fba57273fa5f89b843653db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b88eeda9_c9b62b91",
        "filename": "src/libANGLE/renderer/vulkan/SurfaceVk.cpp",
        "patchSetId": 9
      },
      "lineNbr": 3186,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2024-08-30T13:28:32Z",
      "side": 1,
      "message": "The entry points for a few functions call `EGL_PrepareSwapBuffersANGLE` automatically, such as `EGL_SwapBuffers*` and `EGL_QuerySurface64` with `EGL_BUFFER_AGE`. The backend relies on `prepareSwap()` having been called.\n\nSo using `NeedToProcessAcquireNextImageResult` and `postProcessUnlockedTryAcquire` was right here",
      "parentUuid": "a2e14019_7421eb23",
      "revId": "cfffd82485b6d4065fba57273fa5f89b843653db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4874e4af_45d8539c",
        "filename": "src/libANGLE/renderer/vulkan/SurfaceVk.cpp",
        "patchSetId": 9
      },
      "lineNbr": 3186,
      "author": {
        "id": 1564492
      },
      "writtenOn": "2024-08-30T13:34:52Z",
      "side": 1,
      "message": "Then the question is why `swapImpl()` calls `doDeferredAcquireNextImage()` and not `postProcessUnlockedTryAcquire()`?",
      "parentUuid": "b88eeda9_c9b62b91",
      "revId": "cfffd82485b6d4065fba57273fa5f89b843653db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "eaa2a315_35f15ad9",
        "filename": "src/libANGLE/renderer/vulkan/SurfaceVk.cpp",
        "patchSetId": 9
      },
      "lineNbr": 3186,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2024-08-30T13:42:39Z",
      "side": 1,
      "message": "I have to refresh my memory, maybe you\u0027re right and `needsAcquireImageOrProcessResult` is fine... it\u0027s certainly safer.\n\nPreviously, `NeedToProcessAcquireNextImageResult` was called because of `ASSERT(!mAcquireOperation.needToAcquireNextSwapchainImage);`, so the code here was a stripped version of what is called in `swapImpl`. I don\u0027t remember why that assumption exists and why `swapImpl` cannot assume the same.\n\nI need to step out for an hour, but I\u0027ll take a look again when I get back.",
      "parentUuid": "4874e4af_45d8539c",
      "revId": "cfffd82485b6d4065fba57273fa5f89b843653db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "94928215_6787d445",
        "filename": "src/libANGLE/renderer/vulkan/SurfaceVk.cpp",
        "patchSetId": 9
      },
      "lineNbr": 3186,
      "author": {
        "id": 1564492
      },
      "writtenOn": "2024-08-30T15:42:51Z",
      "side": 1,
      "message": "I found 2 reasons why need to use `doDeferredAcquireNextImage()` in `swapImpl()`:\n1. ANI in the `prepareSwap()` may return `VK_ERROR_OUT_OF_DATE_KHR`. We need to process this result and recreate the swapchain instead of returning error if only use `postProcessUnlockedTryAcquire()`.\n2. In case of shared present mode, `swapImpl()` may be called from `WindowSurfaceVk::onSharedPresentContextFlush()`.\n\nThe (1) is also true for `getBufferAge()`, but in this case we may use `doDeferredAcquireNextImageWithUsableSwapchain()` and keep the ASSERT.\n\nI\u0027m currently trying to write test to reproduce `mAcquireOperation.needToAcquireNextSwapchainImage \u003d\u003d true` in the `swapImpl()`.",
      "parentUuid": "eaa2a315_35f15ad9",
      "revId": "cfffd82485b6d4065fba57273fa5f89b843653db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "b09eafa0_6ac48da9",
        "filename": "src/libANGLE/renderer/vulkan/SurfaceVk.cpp",
        "patchSetId": 9
      },
      "lineNbr": 3186,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2024-08-30T15:47:47Z",
      "side": 1,
      "message": "üëç I was going to point out (2). that was the only difference I could think of.\n\nThe code you have here should be safe either way, so given (1), let\u0027s go with this.",
      "parentUuid": "94928215_6787d445",
      "revId": "cfffd82485b6d4065fba57273fa5f89b843653db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "e0322660_7260927c",
        "filename": "src/libANGLE/renderer/vulkan/SurfaceVk.cpp",
        "patchSetId": 9
      },
      "lineNbr": 3186,
      "author": {
        "id": 1564492
      },
      "writtenOn": "2024-08-30T19:41:40Z",
      "side": 1,
      "message": "@syoussefi@chromium.org\n\nUpdated `getBufferAge()` to use `doDeferredAcquireNextImageWithUsableSwapchain()` and returned the ASSERT.\n\nAdded comments and `AcquireImageFromSwapImpl` test to cover point (2). Existing tests do not cover this particular case. Also added ASSERTs in to `present()` to catch possible errors, if image was not acquired/processed.\n\n@cclao@google.com\n\nPlease take a look at new changes. Thanks!",
      "parentUuid": "b09eafa0_6ac48da9",
      "revId": "cfffd82485b6d4065fba57273fa5f89b843653db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}