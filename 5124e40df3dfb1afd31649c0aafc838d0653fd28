{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "e2dd023d_7b43499d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2021-09-02T19:53:15Z",
      "side": 1,
      "message": "Hi Sunny,\n\nThis CL makes ANGLE use Vulkan secondary command buffers. It doesn\u0027t produce any validation errors, but it\u0027s clearly buggy as it randomly fails tests on all platforms. Running some test through RenderDoc however, the test behaves correctly.\n\nI haven\u0027t pinpointed yet what the issue might be. Running it on a debug build of your driver would probably provide useful insights as to what ANGLE is doing wrong here, so I would appreciate your help with this.\n\nOnce the CL is fixed, you should be able to try it out for performance comparisons :)",
      "revId": "5124e40df3dfb1afd31649c0aafc838d0653fd28",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "04202799_5f56c242",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1323708
      },
      "writtenOn": "2021-09-07T10:18:51Z",
      "side": 1,
      "message": "Mali Vulkan driver doesn\u0027t support inheritedQueries, so we cannot run GLES30 applications.\nFor T-Rex, its FPS drops \u003e 20%\nI can provide some more details tomorrow if it\u0027s needed",
      "parentUuid": "e2dd023d_7b43499d",
      "revId": "5124e40df3dfb1afd31649c0aafc838d0653fd28",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fabc5f02_9cd89ac8",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2021-09-07T16:39:55Z",
      "side": 1,
      "message": "\u003e Mali Vulkan driver doesn\u0027t support inheritedQueries, so we cannot run GLES30 applications.\n\nRight, we actually should stop requiring that feature. I removed that here: https://chromium-review.googlesource.com/c/angle/angle/+/3145611\n\n\u003e For T-Rex, its FPS drops \u003e 20%\n\nThat\u0027s surprising (1). If you run deqp, do you see test failures like we see on our bots? There might be something wrong with the command buffers we submit, and I don\u0027t really know what that could be at the moment.\n\n(1) I noticed that we actually generate a lot of tiny secondary command buffers outside a render pass (basically every time an execution barrier is needed that can\u0027t be merged with the previous). That might be the reason?",
      "parentUuid": "04202799_5f56c242",
      "revId": "5124e40df3dfb1afd31649c0aafc838d0653fd28",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "e05e0b79_9f5f8ffc",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1323708
      },
      "writtenOn": "2021-09-08T03:07:13Z",
      "side": 1,
      "message": "After switch to 3.0 context, T-Rex has no drop, and MH30/31 are also fine.\nBut the driver overhead 2 still has big drop (~60%), I see our driver has spent much time on vkCmdExecuteCommands, and this API doesn\u0027t get called before without this change.\nRegarding the deqp failure, I didn\u0027t see any failures if run the tests individually, but run the whole will cause OOM, so there is memory leak",
      "parentUuid": "fabc5f02_9cd89ac8",
      "revId": "5124e40df3dfb1afd31649c0aafc838d0653fd28",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9e4829dd_02c01215",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2021-09-08T04:00:58Z",
      "side": 1,
      "message": "\u003e so there is memory leak\n\nYes that\u0027s likely, I probably missed some clean up or left a TODO about it there.\n\n\u003e After switch to 3.0 context, T-Rex has no drop\n\nGreat, the drop must have been due to cube map sampling emulation or something like that.\n\n\u003e But the driver overhead 2 still has big drop (~60%), I see our driver has spent much time on vkCmdExecuteCommands, and this API doesn\u0027t get called before without this change.\n\nOk, that\u0027s exactly what\u0027s going on (previously we replayed the ANGLE secondary CBs on the primary CB, and now we are calling vkCmdExecuteCommands).\n\nDoes this answer your curiosity regarding whether switching to Vulkan secondary CBs would be a win or not? Do you intend to make optimization attempts to this change or your driver to see if you could turn this into a win?",
      "parentUuid": "e05e0b79_9f5f8ffc",
      "revId": "5124e40df3dfb1afd31649c0aafc838d0653fd28",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}