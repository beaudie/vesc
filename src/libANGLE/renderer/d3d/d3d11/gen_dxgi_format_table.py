#!/usr/bin/python
# Copyright 2016 The ANGLE Project Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.
#
# gen_dxgi_format_table.py:
#  Code generation for DXGI format map.

from datetime import date
import sys

sys.path.append('../..')
import angle_format

template_cpp = """// GENERATED FILE - DO NOT EDIT.
// Generated by {script_name} using data from {data_source_name}.
//
// Copyright {copyright_year} The ANGLE Project Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.
//
// DXGI format info:
//   Determining metadata about a DXGI format.

#include "angle_gl.h"
#include "common/debug.h"

namespace rx
{{

namespace d3d11
{{
    
GLenum GetComponentType(DXGI_FORMAT dxgiFormat)
{{
    switch (dxgiFormat)
    {{
{component_type_cases}        default:
            break;
    }}

    UNREACHABLE();
    return GL_NONE;
}}

}}  // namespace d3d11

}}  // namespace rx
"""

template_component_case = """        case DXGI_FORMAT_{dxgi_format}:
            return {component_type};
"""

template_undefined_component_case = """        case DXGI_FORMAT_{dxgi_format}:
            break;
"""

def component_case(dxgi_format, component_type):
    return template_component_case.format(
        dxgi_format = dxgi_format,
        component_type = component_type)

def undefined_component_case(dxgi_format):
    return template_undefined_component_case.format(
        dxgi_format = dxgi_format)

component_cases = ""

input_data = 'dxgi_format_data.json'

dxgi_map = angle_format.load_json(input_data)

types = {
    'SNORM': 'GL_SIGNED_NORMALIZED',
    'UNORM': 'GL_UNSIGNED_NORMALIZED',
    'SINT': 'GL_INT',
    'UINT': 'GL_UNSIGNED_INT',
    'FLOAT': 'GL_FLOAT',
    'TYPELESS': 'GL_NONE'
}

for dxgi_format, v in sorted(dxgi_map.iteritems()):

    found = [ctype in dxgi_format for ctype in types.keys()]
    count = reduce((lambda a, b: int(a) + int(b)), found)

    component_type = 'GL_NONE'

    if count == 1:
        gltype = next(gltype for ctype, gltype in types.iteritems() if ctype in dxgi_format)
        component_cases += component_case(dxgi_format, gltype)
    else:
        component_cases += undefined_component_case(dxgi_format)

with open('dxgi_format_map_autogen.cpp', 'wt') as out_file:
    output_cpp = template_cpp.format(
        script_name = sys.argv[0],
        data_source_name = input_data,
        copyright_year = date.today().year,
        component_type_cases = component_cases)
    out_file.write(output_cpp)
    out_file.close()
