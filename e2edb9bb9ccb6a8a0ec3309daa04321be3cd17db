{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "1a83ea2a_84c744a8",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 9
      },
      "lineNbr": 0,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2022-06-23T17:41:10Z",
      "side": 1,
      "message": "Is this expected to ship or is it just for testing? It\u0027s not particularly big, but it does add ~50KB of binary size to an Android build (which is particularly redundant, as Android vendors support ASTC).\n\nAlso, looks like the decoding is buggy. For example look at the GOLD failure for war_planet_online, especially the foliage looks very blurry.\n",
      "revId": "e2edb9bb9ccb6a8a0ec3309daa04321be3cd17db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "0d39f7bc_5ccf5277",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 9
      },
      "lineNbr": 0,
      "author": {
        "id": 1256237
      },
      "writtenOn": "2022-06-23T17:43:28Z",
      "side": 1,
      "message": "I approved a bunch of the image diffs that were minor, but not `car_chase` yet since it is clearly wrong.  It may have nothing to do with the texture format, it is the first time it has run on Nvidia, may need a skip.",
      "revId": "e2edb9bb9ccb6a8a0ec3309daa04321be3cd17db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2692bc8a_3b12b1c0",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 9
      },
      "lineNbr": 0,
      "author": {
        "id": 1256237
      },
      "writtenOn": "2022-06-23T17:53:57Z",
      "side": 1,
      "message": "I noticed some of the diffs (including war_planet_online) almost looked like a different LOD was selected.  I approved them since it was comparing against a different platform and weren\u0027t glaringly bad.  We\u0027ve always had minor differences when textures are involved.\n\nLubosz, I can un-approve the blurry images if you\u0027d like to look closer at them.\n\nI think the real world intent is for this to be for testing, but I don\u0027t think we\u0027re blocking it anywhere.  Only including it for platforms that need it is interesting, especially to reduce binary size.",
      "parentUuid": "1a83ea2a_84c744a8",
      "revId": "e2edb9bb9ccb6a8a0ec3309daa04321be3cd17db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fe5a0a1c_fa23051f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 9
      },
      "lineNbr": 0,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2022-06-24T02:13:33Z",
      "side": 1,
      "message": "Ah makes sense, I once again forgot to check that. It may very well not be the fault of the emulation, though a quick check with RenderDoc to make sure the emulated and original textures look the same (for example on Nvidia vs Pixel) would be nice.\n\nIn the very least, I\u0027d suggest adding a gn arg for it that\u0027s defaulted to !android.",
      "parentUuid": "2692bc8a_3b12b1c0",
      "revId": "e2edb9bb9ccb6a8a0ec3309daa04321be3cd17db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "e83515d7_427d80d7",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 9
      },
      "lineNbr": 0,
      "author": {
        "id": 1491687
      },
      "writtenOn": "2022-06-24T15:15:21Z",
      "side": 1,
      "message": "I am now disabling build and usage of the library on `is_android`. This reduced the debug APK size by ~90kb for me.",
      "parentUuid": "fe5a0a1c_fa23051f",
      "revId": "e2edb9bb9ccb6a8a0ec3309daa04321be3cd17db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "5f4e61a3_83c57563",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 9
      },
      "lineNbr": 0,
      "author": {
        "id": 1491687
      },
      "writtenOn": "2022-06-24T15:15:21Z",
      "side": 1,
      "message": "I ran `car_chase` with ASTC emulation on AMD/Mesa and did not encounter the visual artifacts visible in the Gold tests. It might be unrelated to ASTC and require a skip on NVIDIA.",
      "parentUuid": "0d39f7bc_5ccf5277",
      "revId": "e2edb9bb9ccb6a8a0ec3309daa04321be3cd17db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "450af627_4ccb074f",
        "filename": "src/image_util/loadimage_astc.cpp",
        "patchSetId": 9
      },
      "lineNbr": 33,
      "author": {
        "id": 1256237
      },
      "writtenOn": "2022-06-23T17:43:28Z",
      "side": 1,
      "message": "Much of the code in this function doesn\u0027t align with ANGLE\u0027s formatting rules, but I can see that it does match the rules used by the library (snake_case).  I\u0027m okay leaving it as you\u0027ve uploaded it to keep the code easy to read.",
      "range": {
        "startLine": 33,
        "startChar": 0,
        "endLine": 33,
        "endChar": 42
      },
      "revId": "e2edb9bb9ccb6a8a0ec3309daa04321be3cd17db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b708f8a6_f90f360a",
        "filename": "src/image_util/loadimage_astc.cpp",
        "patchSetId": 9
      },
      "lineNbr": 33,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2022-06-23T18:23:21Z",
      "side": 1,
      "message": "Preference is to use ANGLE\u0027s style. Instead of `static const`, please use `constexpr`, and the name would look like `kBlockZ`.",
      "parentUuid": "450af627_4ccb074f",
      "range": {
        "startLine": 33,
        "startChar": 0,
        "endLine": 33,
        "endChar": 42
      },
      "revId": "e2edb9bb9ccb6a8a0ec3309daa04321be3cd17db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c367d2e9_72f5673a",
        "filename": "src/image_util/loadimage_astc.cpp",
        "patchSetId": 9
      },
      "lineNbr": 33,
      "author": {
        "id": 1491687
      },
      "writtenOn": "2022-06-24T15:15:21Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "b708f8a6_f90f360a",
      "range": {
        "startLine": 33,
        "startChar": 0,
        "endLine": 33,
        "endChar": 42
      },
      "revId": "e2edb9bb9ccb6a8a0ec3309daa04321be3cd17db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7c486560_087acbc6",
        "filename": "src/image_util/loadimage_astc.cpp",
        "patchSetId": 9
      },
      "lineNbr": 36,
      "author": {
        "id": 1256237
      },
      "writtenOn": "2022-06-23T17:43:28Z",
      "side": 1,
      "message": "Can you provide any context for how you chose these defaults?  If performance of the library becomes a problem, these might be knobs we can tweak.",
      "range": {
        "startLine": 34,
        "startChar": 0,
        "endLine": 36,
        "endChar": 59
      },
      "revId": "e2edb9bb9ccb6a8a0ec3309daa04321be3cd17db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ace912a0_ba48aeba",
        "filename": "src/image_util/loadimage_astc.cpp",
        "patchSetId": 9
      },
      "lineNbr": 36,
      "author": {
        "id": 1491687
      },
      "writtenOn": "2022-06-24T15:15:21Z",
      "side": 1,
      "message": "The `astcenc_profile` is related to the input data we are receiving. It is set to `ASTCENC_PRF_LDR` as we currently only emulate `GL_KHR_texture_compression_astc_ldr`. The other profile would be relevant if we also exposed `GL_KHR_texture_compression_astc_hdr`.\n\nI chose `ASTCENC_PRE_MEDIUM` quality as it was the default used in the library\u0027s example code. Benchmarking against `ASTCENC_PRE_FASTEST` only gave a performance gain of `0.575s` when loading up the `war_planet_online` trace.\n\nLooking into the library the quality option is also mostly related to encoding, I am not sure it is actually used during decoding. SwiftShader has a modified version of the library with encoding stripped out, and does not have the notion of quality profiles at all.\n\nFor performance on Debug builds, it turns out that setting `-02` for only the `astc-encoder` library is enough to cut down loading times significantly.\nIn the benchmark I am using the `time` command with `--max-steps-performed 1` to time the full duration of the load up. So it contains the performance impact of loading up the shaders as well, compared to release builds.\n\nMy suggestion is to append `-O2` when building angle with `is_debug \u003d true`.\n\nFull benchmarks:\n\n```\ntime ./out/Debug/angle_perftests --gtest_filter\u003dTracePerfTest.Run/vulkan_war_planet_online --max-steps-performed 1\n```\n\n```\n2m36.226s No optimizations\n2m36.568s Thread count set to 24 (using a 24 thread CPU)\n2m35.651s ASTCENC_PRE_FASTEST profile\n2m25.026s SSE4.1 (ASTCENC_SSE\u003d1 and -msse4.1)\n2m12.339s SSE 4.1 and link time optimization (ASTCENC_SSE\u003d1 and -msse4.1 -flto)\n0m42.648s -O2 on only `astc-encoder`\n0m42.255s -O3 on only `astc-encoder`\n0m 6.518s Release build\n```",
      "parentUuid": "7c486560_087acbc6",
      "range": {
        "startLine": 34,
        "startChar": 0,
        "endLine": 36,
        "endChar": 59
      },
      "revId": "e2edb9bb9ccb6a8a0ec3309daa04321be3cd17db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "74b74a24_2b146374",
        "filename": "src/image_util/loadimage_astc.cpp",
        "patchSetId": 9
      },
      "lineNbr": 36,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2022-06-27T15:25:49Z",
      "side": 1,
      "message": "\u003e SwiftShader has a modified version of the library with encoding stripped out\n\nIs there a way for ANGLE to share that? The binary size still affects builds of ANGLE distributed on desktop through Chrome.\n\n\u003e My suggestion is to append `-O2` when building angle with `is_debug \u003d true`\n\nThat will actually make debugging harder.\n\n\u003e For performance on Debug builds, it turns out that setting `-02` for only the `astc-encoder` library is enough to cut down loading times significantly\n\nI wasn\u0027t aware that load time is an issue with this, but if the alternative is \"can\u0027t run\", it\u0027s acceptable. However, we should be able to build this library itself with optimization, while the rest of ANGLE is built without optimization. This is how we have disabled optimization somewhere I could find:\n\n```\nconfigs +\u003d [ \"//build/config/compiler:no_optimize\" ]\n```\n\nProbably adding this to the build of the ASTC lib would do:\n\n```\nconfigs +\u003d [ \"//build/config/compiler:optimize\" ]\n```",
      "parentUuid": "ace912a0_ba48aeba",
      "range": {
        "startLine": 34,
        "startChar": 0,
        "endLine": 36,
        "endChar": 59
      },
      "revId": "e2edb9bb9ccb6a8a0ec3309daa04321be3cd17db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "dbe4eadb_04209d76",
        "filename": "src/image_util/loadimage_astc.cpp",
        "patchSetId": 9
      },
      "lineNbr": 36,
      "author": {
        "id": 1491687
      },
      "writtenOn": "2022-06-30T12:16:10Z",
      "side": 1,
      "message": "\u003e Probably adding this to the build of the ASTC lib would do:\nIndeed this has the same performance benefits as adding `-O2` and is more compiler independent. I now enable this only for `is_debug` on only the ASTC library.\n\n\u003e The binary size still affects builds of ANGLE distributed on desktop through Chrome.\n\nI now only enable the build of the library on `angle_standalone`, which won\u0027t include it in the Chromium build. The library was already disabled for WebGL, so it makes sense not to built it in these cases.\n\n\u003e Is there a way for ANGLE to share that?\n\nSwiftShader\u0027s fork of the library could be built using the SwiftShader third_party module. Unfortunately SwiftShader remove all the library API, so the entry points I am currently using won\u0027t be available and the `loadimage_astc.cpp` would need a complete rewrite.\nThe advantage of using `astc-decoder` directly is to benefit from upstream changes. The SwiftShader fork did not see updates since it landed.\nIn addition, I am disabling the part SwiftShader removed at build time anyway, through the `ASTCENC_DECOMPRESS_ONLY` define. So the binary size should not differ much.",
      "parentUuid": "74b74a24_2b146374",
      "range": {
        "startLine": 34,
        "startChar": 0,
        "endLine": 36,
        "endChar": 59
      },
      "revId": "e2edb9bb9ccb6a8a0ec3309daa04321be3cd17db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "cd1635ef_727db503",
        "filename": "src/image_util/loadimage_astc.cpp",
        "patchSetId": 9
      },
      "lineNbr": 36,
      "author": {
        "id": 1491687
      },
      "writtenOn": "2022-07-12T11:07:33Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "dbe4eadb_04209d76",
      "range": {
        "startLine": 34,
        "startChar": 0,
        "endLine": 36,
        "endChar": 59
      },
      "revId": "e2edb9bb9ccb6a8a0ec3309daa04321be3cd17db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fbdd75cd_99fc296c",
        "filename": "src/image_util/loadimage_astc.cpp",
        "patchSetId": 9
      },
      "lineNbr": 47,
      "author": {
        "id": 1256237
      },
      "writtenOn": "2022-06-23T17:43:28Z",
      "side": 1,
      "message": "Multiple decode threads might help the slow debug performance as well.",
      "range": {
        "startLine": 47,
        "startChar": 30,
        "endLine": 47,
        "endChar": 42
      },
      "revId": "e2edb9bb9ccb6a8a0ec3309daa04321be3cd17db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "21b5b41d_760e5993",
        "filename": "src/image_util/loadimage_astc.cpp",
        "patchSetId": 9
      },
      "lineNbr": 47,
      "author": {
        "id": 1491687
      },
      "writtenOn": "2022-06-24T15:15:21Z",
      "side": 1,
      "message": "I tried setting this to 24 on a 24 thread CPU and did not notice any performance benefit at all. Also looking into the process manager, it did not seem to start up more threads.\n\nAgain, looking into the library code it seems that this parameter is used for compression, being guarded behind that needs `ASTCENC_DECOMPRESS_ONLY` unset, which we have set.",
      "parentUuid": "fbdd75cd_99fc296c",
      "range": {
        "startLine": 47,
        "startChar": 30,
        "endLine": 47,
        "endChar": 42
      },
      "revId": "e2edb9bb9ccb6a8a0ec3309daa04321be3cd17db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9fc5c1db_ce0cbfc9",
        "filename": "src/image_util/loadimage_astc.cpp",
        "patchSetId": 9
      },
      "lineNbr": 47,
      "author": {
        "id": 1491687
      },
      "writtenOn": "2022-06-30T12:16:10Z",
      "side": 1,
      "message": "As this has only effects when encoding and I am adding `configs +\u003d [ \"//build/config/compiler:optimize\" ]` for debug builds to improve performance I am marking this as resolved.",
      "parentUuid": "21b5b41d_760e5993",
      "range": {
        "startLine": 47,
        "startChar": 30,
        "endLine": 47,
        "endChar": 42
      },
      "revId": "e2edb9bb9ccb6a8a0ec3309daa04321be3cd17db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cc66c53c_200a9684",
        "filename": "src/image_util/loadimage_astc.cpp",
        "patchSetId": 9
      },
      "lineNbr": 58,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2022-06-23T18:23:21Z",
      "side": 1,
      "message": "nit: static_cast",
      "range": {
        "startLine": 58,
        "startChar": 30,
        "endLine": 58,
        "endChar": 31
      },
      "revId": "e2edb9bb9ccb6a8a0ec3309daa04321be3cd17db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "7d6ad4a4_430ee46a",
        "filename": "src/image_util/loadimage_astc.cpp",
        "patchSetId": 9
      },
      "lineNbr": 58,
      "author": {
        "id": 1491687
      },
      "writtenOn": "2022-06-24T15:15:21Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "cc66c53c_200a9684",
      "range": {
        "startLine": 58,
        "startChar": 30,
        "endLine": 58,
        "endChar": 31
      },
      "revId": "e2edb9bb9ccb6a8a0ec3309daa04321be3cd17db",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}