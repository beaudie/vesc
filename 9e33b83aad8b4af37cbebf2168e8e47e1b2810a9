{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "4ff11ab6_8c4cccc6",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 10,
      "author": {
        "id": 1340649
      },
      "writtenOn": "2023-02-14T21:10:04Z",
      "side": 1,
      "message": "fyi - after threadB calls `eglTerminate` is destroyed there are no more active threads in which case, at least on Android platforms, the thread cleanup code will kick in and destroy `ctx` and `srf` (see here -\u003e https://cs.android.com/android/platform/superproject/+/master:external/angle/src/libANGLE/Display.cpp;l\u003d1262)\n\ni confirmed that when checking in this test on our platform",
      "range": {
        "startLine": 9,
        "startChar": 0,
        "endLine": 10,
        "endChar": 57
      },
      "revId": "9e33b83aad8b4af37cbebf2168e8e47e1b2810a9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "3cf48029_9984eee8",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 10,
      "author": {
        "id": 1392020
      },
      "writtenOn": "2023-02-14T21:21:27Z",
      "side": 1,
      "message": "You can set breakpoint on CommandQueue::init and CommandQueue::destroy, they are not equal. If you follow through eglTerminate, it bails out early because the context still have a reference count. So the bug for sure does exist.\n\nBut you have a good point. It might be that Display::threadCleanup(Thread *thread) has a bug here that it does not actually destroys the current context. If you could follow up with a better fix, that would be great.",
      "parentUuid": "4ff11ab6_8c4cccc6",
      "range": {
        "startLine": 9,
        "startChar": 0,
        "endLine": 10,
        "endChar": 57
      },
      "revId": "9e33b83aad8b4af37cbebf2168e8e47e1b2810a9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4bf103d1_e8b3dbb5",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 10,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2023-02-14T21:28:40Z",
      "side": 1,
      "message": "FWIW, the spec seems to say that the context stays current and doesn\u0027t get destroyed after eglTerminate. eglMakeCurrent is still necessary.",
      "parentUuid": "3cf48029_9984eee8",
      "range": {
        "startLine": 9,
        "startChar": 0,
        "endLine": 10,
        "endChar": 57
      },
      "revId": "9e33b83aad8b4af37cbebf2168e8e47e1b2810a9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "cd329473_8669883d",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 10,
      "author": {
        "id": 1392020
      },
      "writtenOn": "2023-02-14T21:30:46Z",
      "side": 1,
      "message": "Right, that point is agreed. But what if the thread gets destroyed, should context attached to that thread also automatically becomes unCurrent and destroyed? What is the expected behavior here?",
      "parentUuid": "4bf103d1_e8b3dbb5",
      "range": {
        "startLine": 9,
        "startChar": 0,
        "endLine": 10,
        "endChar": 57
      },
      "revId": "9e33b83aad8b4af37cbebf2168e8e47e1b2810a9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fa770c08_6e8195a2",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 10,
      "author": {
        "id": 1340649
      },
      "writtenOn": "2023-02-14T21:36:33Z",
      "side": 1,
      "message": "\u003e If you follow through eglTerminate, it bails out early because the context still have a reference count\n\nare you doing the breakpoint lookup on Android? if so, that is not expected behavior. Since threadB is the last active thread on that display `terminate` will be called with `TerminateReason::NoActiveThreads` here -\u003e \nhttps://cs.android.com/android/platform/superproject/+/master:external/angle/src/libANGLE/Display.cpp;l\u003d1267\n\nin which case `Display::terminate` will force `unMakeCurrent` the context here -\u003e https://cs.android.com/android/platform/superproject/+/master:external/angle/src/libANGLE/Display.cpp;l\u003d1172",
      "parentUuid": "cd329473_8669883d",
      "range": {
        "startLine": 9,
        "startChar": 0,
        "endLine": 10,
        "endChar": 57
      },
      "revId": "9e33b83aad8b4af37cbebf2168e8e47e1b2810a9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}