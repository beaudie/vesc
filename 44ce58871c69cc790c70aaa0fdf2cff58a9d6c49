{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "68c9ca11_ae8a69e8",
        "filename": "src/libANGLE/renderer/vulkan/vk_cache_utils.cpp",
        "patchSetId": 22
      },
      "lineNbr": 4316,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2024-04-29T19:11:47Z",
      "side": 0,
      "message": "I\u0027d like to again point out that before, doing updates to binding 0 then 1, or 1 then 0 ended up with the same desc. Now they end up with two different descs. If instead you\u0027d do this (UNTESTED CODE):\n\n```\nif (bindingIndex \u003e\u003d mPackedDescriptorSetLayout.size())\n{\n    mPackedDescriptorSetLayout.resize(bindingIndex + 1);\n}\nPackedDescriptorSetBinding \u0026packedBinding \u003d mPackedDescriptorSetLayout[bindingIndex];\n```\n\nyou can bring back that behavior. I can\u0027t really guess what works better though, if the updates to bindings are consistent, what this CL has gives better packing and is better. If they are not consistent, then the suggestion results in better cache hits.\n\nDo you think you could run an experiment to see if the cache hit rate is reduced with this change?\n\n---\n\nFWIW, making `bindingIndex` implicit (by placing the entry in the corresponding slot), you can also reduce the `PackedDescriptorSetBinding` struct back to 32-bit for a small CPU perf gain. Also good to measure.",
      "revId": "44ce58871c69cc790c70aaa0fdf2cff58a9d6c49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c48195b2_85d5b935",
        "filename": "src/libANGLE/renderer/vulkan/vk_cache_utils.cpp",
        "patchSetId": 22
      },
      "lineNbr": 4316,
      "author": {
        "id": 1340649
      },
      "writtenOn": "2024-04-29T19:52:45Z",
      "side": 0,
      "message": "\u003e If instead you\u0027d do this ... mPackedDescriptorSetLayout.resize(bindingIndex + 1);\n\napps are free to choose any bindingIndex, so an app can have only 2 bindings with `bindingIndex \u003d\u003d {3, 45}` in which case we will end up alloc\u0027ing a `FastVector` of size 46 instead of 2. do we want that?\n\n\u003e if the updates to bindings are consistent\n\n`ProgramExecutableVk::createPipelineLayout` is where most of the work happens but we rely on vectors built in various other locations so guaranteeing consistent ordering is not easy. If we need to have order agnostic cache hits and have optimal space consumption I guess we are back to some sort of map (but this was causing failures with pixel bots which i did not look into much)\n\n\u003e what this CL has gives better packing and is better\n\nyeah, for \u003e 90% traces we can fit `mPackedDescriptorSetLayout` in a single cache line",
      "parentUuid": "68c9ca11_ae8a69e8",
      "revId": "44ce58871c69cc790c70aaa0fdf2cff58a9d6c49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0fc6f97c_7184160b",
        "filename": "src/libANGLE/renderer/vulkan/vk_cache_utils.cpp",
        "patchSetId": 22
      },
      "lineNbr": 4316,
      "author": {
        "id": 1392020
      },
      "writtenOn": "2024-04-30T00:15:21Z",
      "side": 0,
      "message": "I actually was thinking what Shabi described above as well. Basically keep the way how it works as before but get rid of excessive zeros at the end. I didn\u0027t realize this CL is doing slightly different ways, but if data shows new way is better I am fine too. \n\n\"apps are free to choose any bindingIndex\", true, but is any real app actually doing that way? The point here is to optimize the actual usage pattern we are seeing in real app.",
      "parentUuid": "c48195b2_85d5b935",
      "revId": "44ce58871c69cc790c70aaa0fdf2cff58a9d6c49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "01db6a15_39c012ee",
        "filename": "src/libANGLE/renderer/vulkan/vk_cache_utils.cpp",
        "patchSetId": 22
      },
      "lineNbr": 4316,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2024-04-30T13:57:43Z",
      "side": 0,
      "message": "\u003e but is any real app actually doing that way? The point here is to optimize the actual usage pattern we are seeing in real app.\n\nExactly, which is why I suggested this:\n\n\u003e Do you think you could run an experiment to see if the cache hit rate is reduced with this change?\n\nIf cache hit rate is not affected by this change, I\u0027m fine with this better packing. If it is affected, we\u0027ll have to measure the trade off.",
      "parentUuid": "0fc6f97c_7184160b",
      "revId": "44ce58871c69cc790c70aaa0fdf2cff58a9d6c49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "32a3de54_5eb638eb",
        "filename": "src/libANGLE/renderer/vulkan/vk_cache_utils.cpp",
        "patchSetId": 22
      },
      "lineNbr": 4316,
      "author": {
        "id": 1340649
      },
      "writtenOn": "2024-05-01T12:46:34Z",
      "side": 0,
      "message": "i have added the data here -\u003e https://anglebug.com/8677#c7\n\nThere are no changes in cache hit / miss count but there is a sizable reduction in hashed bytes and hashing times",
      "parentUuid": "01db6a15_39c012ee",
      "revId": "44ce58871c69cc790c70aaa0fdf2cff58a9d6c49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b378ba06_63586ef1",
        "filename": "src/libANGLE/renderer/vulkan/vk_cache_utils.cpp",
        "patchSetId": 22
      },
      "lineNbr": 4316,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2024-05-01T13:51:50Z",
      "side": 0,
      "message": "Nice! Do you think you could do another experiment with my suggestion to make bindingIndex implicit? In particular, the `PackedDescriptorSetBinding` can become 32-bit instead of 64-bit, and if apps do keep their bindings packed (as one would imagine they would) then the hash could be even faster:\n\n```\n        struct\n        {\n            uint8_t type;                  // Stores a packed VkDescriptorType descriptorType.\n            uint8_t stages;                // Stores a packed VkShaderStageFlags.\n            uint16_t count : 15;           // Stores a packed uint32_t descriptorCount\n            uint16_t hasImmutableSampler : 1; // Whether this binding has an immutable sampler\n        };\n```",
      "parentUuid": "32a3de54_5eb638eb",
      "revId": "44ce58871c69cc790c70aaa0fdf2cff58a9d6c49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6c08b5fb_c7d1d1de",
        "filename": "src/libANGLE/renderer/vulkan/vk_cache_utils.cpp",
        "patchSetId": 22
      },
      "lineNbr": 4316,
      "author": {
        "id": 1340649
      },
      "writtenOn": "2024-05-01T16:06:36Z",
      "side": 0,
      "message": "\u003e the PackedDescriptorSetBinding can become 32-bit instead of 64-bit\n\nwe will pull in the full cache line so the advantage would only be for apps that have binding count \u003e 8?\n\n\u003e if apps do keep their bindings packed\n\ni have only logged the max binding count not the binding indices themselves, so im not sure if they are indeed packed. i am going to collect that data before making the change",
      "parentUuid": "b378ba06_63586ef1",
      "revId": "44ce58871c69cc790c70aaa0fdf2cff58a9d6c49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "205ced8c_086f08d4",
        "filename": "src/libANGLE/renderer/vulkan/vk_cache_utils.cpp",
        "patchSetId": 22
      },
      "lineNbr": 4316,
      "author": {
        "id": 1340649
      },
      "writtenOn": "2024-05-01T17:10:04Z",
      "side": 0,
      "message": "\u003e i am going to collect that data before making the change\n\ni added this logging pseudo-code -\n```\nif (max_binding_index \u003e mDescriptorSetLayoutBindings.size())\n{\n    cout \u003c\u003c \"sparse binding\"\n}\n```\nand no trace emitted this log, so it looks like all traces have packed bindings",
      "parentUuid": "6c08b5fb_c7d1d1de",
      "revId": "44ce58871c69cc790c70aaa0fdf2cff58a9d6c49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "57d59ef0_fcdb690b",
        "filename": "src/libANGLE/renderer/vulkan/vk_cache_utils.cpp",
        "patchSetId": 22
      },
      "lineNbr": 4316,
      "author": {
        "id": 1340649
      },
      "writtenOn": "2024-05-01T17:19:52Z",
      "side": 0,
      "message": "\u003e uint16_t count : 15;\n\nthis requirement in spec is concerning -\n```\ndescriptorCount is the number of descriptors contained in the binding ... except if\ndescriptorType is VK_DESCRIPTOR_TYPE_INLINE_UNIFORM_BLOCK in which case\ndescriptorCount is the size in bytes of the inline uniform block\n```\nbut i guess we can worry about it when angle requires vulkan 1.3",
      "parentUuid": "205ced8c_086f08d4",
      "revId": "44ce58871c69cc790c70aaa0fdf2cff58a9d6c49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}