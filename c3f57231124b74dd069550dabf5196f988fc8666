{
  "comments": [
    {
      "key": {
        "uuid": "1f3de85b_749b9633",
        "filename": "src/libANGLE/renderer/vulkan/doc/PresentSemaphores.md",
        "patchSetId": 7
      },
      "lineNbr": 70,
      "author": {
        "id": 1290487
      },
      "writtenOn": "2019-09-03T18:01:10Z",
      "side": 1,
      "message": "I\u0027m thinking of changing the last sentence into something more, that will satisfy the strange/corner-case PEs out there, and keep the rest of the language relatively simple (like you\u0027ve had it).  Something like:\n\nIn addition, the Vulkan specification tries to abstract a large variety of PE architectures, some of which do not behave in a straight-forward manner.  This document describes an approach for destroying semaphores that should work with all valid PE architectures, but will be described in terms of more-common PE architectures (e.g. where the PE only backs each VkImage and VkSemaphore handle with one actual memory object, and where the PE cycles between the swapchain images in a straight-forward manner).  Thus, we speak in terms of the PE is presenting or has finished presenting an image to the user; and we can speak about when a semaphore is provably unused.",
      "revId": "c3f57231124b74dd069550dabf5196f988fc8666",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "db23cda9_4793fe63",
        "filename": "src/libANGLE/renderer/vulkan/doc/PresentSemaphores.md",
        "patchSetId": 7
      },
      "lineNbr": 70,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2019-09-04T19:51:32Z",
      "side": 1,
      "message": "Done. I moved some of this a bit higher in the doc. I reworded the document and avoided PE done/finished altogether.",
      "parentUuid": "1f3de85b_749b9633",
      "revId": "c3f57231124b74dd069550dabf5196f988fc8666",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "eaeed4b1_853fbbc9",
        "filename": "src/libANGLE/renderer/vulkan/doc/PresentSemaphores.md",
        "patchSetId": 7
      },
      "lineNbr": 103,
      "author": {
        "id": 1290487
      },
      "writtenOn": "2019-09-02T19:00:21Z",
      "side": 1,
      "message": "I agreed with the document up till here (well thought-out, written, and presented).  I don\u0027t agree with this bullet for all possible PE architectures (due to things mentioned in the abandoned CL mentioned above).  I think it\u0027s true for most PEs though (e.g. Android).\n\nFor the sake of the document, I suggest removing this bullet.  Perhaps the wording can be changed.  Perhaps I\u0027m inferring something different than you by \"previous presentation ... is finished\".  It sounds to me like it\u0027s saying that the rendered image was shown to the user and now is no longer being shown to the user, because another rendered image is being shown.  Unfortunately, with the current API, you can\u0027t assume anything about when the user starts/stops seeing the rendered image.\n\nI still like the approach you\u0027re taking for managing the semaphores.  This is at least a \"good enough\" approach, and possibly \"one of the best\" approaches for ANGLE to take at this time, given the WSI spec issues.\n\nSorry for being really nit-picky!  This part of WSI is a mess!\n\nFYI ... MoltenVk was the PE that I mentioned in the abandoned CL; the one that allowed an application to get 1000\u0027s of frames in advance.  The fence in your approach will allow you to pace ANGLE with rendering, but not with actual PE presentations.  I recall another proposed/actual desktop driver that did something similar.  I think/hope both changed to bring their behavior more in line with application expectations, but I\u0027m not certain.",
      "revId": "c3f57231124b74dd069550dabf5196f988fc8666",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "145bf5a8_fd711755",
        "filename": "src/libANGLE/renderer/vulkan/doc/PresentSemaphores.md",
        "patchSetId": 7
      },
      "lineNbr": 103,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2019-09-03T15:21:58Z",
      "side": 1,
      "message": "Upon reread, yes the wording could be made more precise. What I _wanted_ to say is this:\n\nIf SAY is signaled, then the presentation engine has decided that I1 can be rendered to. Either this is because it\u0027s presenting some other image or (in the case of IMMEDIATE) doesn\u0027t care if the image is rendered to while being shown on the screen. Either way, the image is officially handed back to the application.\n\nHow about this new wording? \"The PE is done with the previous presentation of I1 (corresponding to SPX) and has handed I1 back to the application\"",
      "parentUuid": "eaeed4b1_853fbbc9",
      "revId": "c3f57231124b74dd069550dabf5196f988fc8666",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5a3209f2_575cb57a",
        "filename": "src/libANGLE/renderer/vulkan/doc/PresentSemaphores.md",
        "patchSetId": 7
      },
      "lineNbr": 103,
      "author": {
        "id": 1290487
      },
      "writtenOn": "2019-09-03T18:01:10Z",
      "side": 1,
      "message": "Given the sentences that I suggested earlier, I\u0027m fine with this new wording.",
      "parentUuid": "145bf5a8_fd711755",
      "revId": "c3f57231124b74dd069550dabf5196f988fc8666",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "77146e13_8a391346",
        "filename": "src/libANGLE/renderer/vulkan/doc/PresentSemaphores.md",
        "patchSetId": 7
      },
      "lineNbr": 103,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2019-09-04T19:51:32Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "5a3209f2_575cb57a",
      "revId": "c3f57231124b74dd069550dabf5196f988fc8666",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f6b2e19f_46bcf329",
        "filename": "src/libANGLE/renderer/vulkan/doc/PresentSemaphores.md",
        "patchSetId": 7
      },
      "lineNbr": 118,
      "author": {
        "id": 1290487
      },
      "writtenOn": "2019-09-02T19:00:21Z",
      "side": 1,
      "message": "Perhaps change to:\n\n\"To summarize, we use the completion of a submission using an image for when it is safe to destroy or reuse the semaphore for the *previous* presentation of that image.\"",
      "revId": "c3f57231124b74dd069550dabf5196f988fc8666",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7045c9bb_6303592f",
        "filename": "src/libANGLE/renderer/vulkan/doc/PresentSemaphores.md",
        "patchSetId": 7
      },
      "lineNbr": 118,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2019-09-03T15:21:58Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "f6b2e19f_46bcf329",
      "revId": "c3f57231124b74dd069550dabf5196f988fc8666",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "7f8c04ca_bc6d8512",
        "filename": "src/libANGLE/renderer/vulkan/doc/PresentSemaphores.md",
        "patchSetId": 7
      },
      "lineNbr": 123,
      "author": {
        "id": 1290487
      },
      "writtenOn": "2019-09-02T19:00:21Z",
      "side": 1,
      "message": "\"... all images are eventually freed ...\"",
      "revId": "c3f57231124b74dd069550dabf5196f988fc8666",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0b675daa_9cd8c6ad",
        "filename": "src/libANGLE/renderer/vulkan/doc/PresentSemaphores.md",
        "patchSetId": 7
      },
      "lineNbr": 123,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2019-09-03T15:21:58Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "7f8c04ca_bc6d8512",
      "revId": "c3f57231124b74dd069550dabf5196f988fc8666",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "6855fcbd_6d9b121e",
        "filename": "src/libANGLE/renderer/vulkan/doc/PresentSemaphores.md",
        "patchSetId": 7
      },
      "lineNbr": 125,
      "author": {
        "id": 1290487
      },
      "writtenOn": "2019-09-02T19:00:21Z",
      "side": 1,
      "message": "I\u0027m not so comfortable with some of the language in this whole \"Swapchain recreation\" section as it\u0027s again inferring when presentations have been done by the PE.  I\u0027ll draw the distinction between what ANGLE should do that should work for most PEs, and what is \"provable\" and what ANGLE can \"rely on\" (which is where my pedantic self starts to have a problem:-).",
      "revId": "c3f57231124b74dd069550dabf5196f988fc8666",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4879d616_9dd0c6ac",
        "filename": "src/libANGLE/renderer/vulkan/doc/PresentSemaphores.md",
        "patchSetId": 7
      },
      "lineNbr": 125,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2019-09-03T15:21:58Z",
      "side": 1,
      "message": "I think the issue is that there are two parts to presentation:\n\n1. The presentation engine is doing something with the image, and therefore needs the image \"locked\".\n2. The image is visible in the window\n\nEvery driver and present mode might be doing something different with 1, I don\u0027t know. But what I understand is that as soon as the Acquire semaphore for the image is signaled, the PE is finished with 1.\n\nI would argue that we don\u0027t need to concern ourselves with 2. My reasoning is this: say you have one swapchain, present images as usual and then terminate the application. Before the window is closed, you need to delete the swapchain and associated semaphores. No matter how much you wait (vkQueueWaitIdle()), the window is going to still show the last presented image. When the swapchain is eventually destroyed, the image is again still viewable in the window.\n\nThat tells me that images being visible in the window is irrelevant to ANGLE. It\u0027s only the first part (where the PE gets the image visible in the window) that would should synchronize with.\n\nSo in the whole document, when I say the PE is finished/done with the image, I mean it\u0027s finished with 1 (i.e. the acquire semaphore for the image has been signaled). With this clarification, what\u0027s your suggestion? I can put this clarification in the doc too (provided you verify that it\u0027s not utter nonsense :D)",
      "parentUuid": "6855fcbd_6d9b121e",
      "revId": "c3f57231124b74dd069550dabf5196f988fc8666",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7494fa17_e2c5f2cd",
        "filename": "src/libANGLE/renderer/vulkan/doc/PresentSemaphores.md",
        "patchSetId": 7
      },
      "lineNbr": 125,
      "author": {
        "id": 1290487
      },
      "writtenOn": "2019-09-03T18:01:10Z",
      "side": 1,
      "message": "You raise good points.  I think we\u0027re quibbling over different subtleties.  This document is about when it\u0027s safe to destroy semaphores.  It also talks about what the PE is doing with the images, which is something the KHR WSI extensions give no visibility into *for all PE architectures*.  My quibbles are about that (when is a PE doing something with an image).",
      "parentUuid": "4879d616_9dd0c6ac",
      "revId": "c3f57231124b74dd069550dabf5196f988fc8666",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d57263b9_1ae9bfc7",
        "filename": "src/libANGLE/renderer/vulkan/doc/PresentSemaphores.md",
        "patchSetId": 7
      },
      "lineNbr": 125,
      "author": {
        "id": 1290487
      },
      "writtenOn": "2019-09-03T19:41:57Z",
      "side": 1,
      "message": "Coming back to this (sorry I don\u0027t know how to make this more concise yet still accurate).  In support of what you\u0027re saying ...\n\nWe could never come up with a good way to model/expose what the PE is doing and when.  For the app questions we were facing (e.g. how to make sure the app didn\u0027t acquire too many images), we rewrote some of the language away from \"ownership\" of an image to when has the app \"acquired\" or \"released\" use of the image.  Unfortunately, we didn\u0027t deal with when it\u0027s safe to destroy semaphores.  As you suggest, you can view the image as \"locked\" at times (you released it via QP and can use it again once the ANI semaphore says it can be used).  After QP, there\u0027s a time when the PE still can\u0027t use the image (e.g. while rendering is occuring, with FIFO).  Some PEs don\u0027t return an image from ANI until the image is ready to use, and some release it once they know which image will eventually be ready to use (using the semaphore to indicate readiness).\n\nFor ANGLE, we care about when the semaphore can be destroyed/reused.  For most PEs, what you wrote is accurate about the state of the PE and the image (which is irrelevant for when it\u0027s safe to destroy/reuse the semaphore, and not accurate for all PEs).  Since it\u0027s how most people think and talk about PEs, it seems fine to use that language as long as there\u0027s a caveat somewhere to indicate that we know there are strange PEs out there (e.g. for when somebody else comes into the ANGLE source code and isn\u0027t aware of strange cases).",
      "parentUuid": "7494fa17_e2c5f2cd",
      "revId": "c3f57231124b74dd069550dabf5196f988fc8666",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2870677c_4ae9366b",
        "filename": "src/libANGLE/renderer/vulkan/doc/PresentSemaphores.md",
        "patchSetId": 7
      },
      "lineNbr": 125,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2019-09-04T19:51:32Z",
      "side": 1,
      "message": "Ok I see your point. I\u0027ll go over the document and try to be more specific about semaphores and not assume any behavior from PEs.",
      "parentUuid": "7494fa17_e2c5f2cd",
      "revId": "c3f57231124b74dd069550dabf5196f988fc8666",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "93ee605e_7c7e771a",
        "filename": "src/libANGLE/renderer/vulkan/doc/PresentSemaphores.md",
        "patchSetId": 7
      },
      "lineNbr": 132,
      "author": {
        "id": 1290487
      },
      "writtenOn": "2019-09-02T19:00:21Z",
      "side": 1,
      "message": "Forgive me, but where is this text coming from?  It sounds familiar, but I don\u0027t remember.",
      "revId": "c3f57231124b74dd069550dabf5196f988fc8666",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9127f061_be13fcf4",
        "filename": "src/libANGLE/renderer/vulkan/doc/PresentSemaphores.md",
        "patchSetId": 7
      },
      "lineNbr": 132,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2019-09-03T15:21:58Z",
      "side": 1,
      "message": "You :)\n\nIt\u0027s not a quote (even though it uses \u003e). I used the style of Vulkan where \"Notes\" or \"Examples\" have a different visual (see how it looks in the rendered page: https://chromium.googlesource.com/angle/angle/+/c3f57231124b74dd069550dabf5196f988fc8666/src/libANGLE/renderer/vulkan/doc/PresentSemaphores.md#swapchain-recreation)",
      "parentUuid": "93ee605e_7c7e771a",
      "revId": "c3f57231124b74dd069550dabf5196f988fc8666",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}