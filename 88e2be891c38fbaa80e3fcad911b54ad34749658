{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "36c6bada_08cab184",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1290487
      },
      "writtenOn": "2020-12-22T18:17:45Z",
      "side": 1,
      "message": "I did an initial/partial review (e.g. I didn\u0027t try to follow the SPIR-V changes) and it LGTM.",
      "revId": "88e2be891c38fbaa80e3fcad911b54ad34749658",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "e4e19bd9_4fccc3a3",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1392020
      },
      "writtenOn": "2020-12-22T18:26:01Z",
      "side": 1,
      "message": "Overall the change itself looks ok to me. My main concern doing in spir-v level is hard to debug. Its like doing it in C versus assembly. If possible, you want to do it in C and let compiler handle for you, avoid coding in assembly. So IMO, using specialization constant is a better choice that has less work (although yu already did spir-v work), better main tenability. The \"unnecessary modifications to early stage\" part is not a real issue, since they will get removed by compiler. The only real issue is the shader size, which is also not a big issue.",
      "revId": "88e2be891c38fbaa80e3fcad911b54ad34749658",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "afb376b1_bfd01813",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1297197
      },
      "writtenOn": "2020-12-22T18:36:32Z",
      "side": 1,
      "message": "I agree with Charlie.   I\u0027d much prefer using specialization constants that are easier to debug/maintain.   Especially with all of the corner cases related to pre-rotation that have been exposed, debugging/maintaining/improving this SPIR-V will essentially be impossible, or at least take much longer than it would with a higher level language.",
      "parentUuid": "e4e19bd9_4fccc3a3",
      "revId": "88e2be891c38fbaa80e3fcad911b54ad34749658",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "71990f0a_f4208f2a",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2020-12-22T19:00:15Z",
      "side": 1,
      "message": "I\u0027d like to argue more for doing this in SPIR-V. First, don\u0027t be discouraged by the size of changes in glslang_wrapper_utils.cpp, most of the change is for SPIR-V generation functions, which should eventually be autogenerated. The only real change here is the snippet of code that says (which is trivial if you actually attempt to read it ðŸ˜Š):\n\n    writeAccessChain(positionPointerId, mVec4OutTypePointerId, mOutputPerVertexId, mInt0Id);\n    writeLoad(positionId, mVec4Id, positionPointerId);\n    writeCompositeExtract(xId, mFloatId, positionId, 0);\n    writeCompositeExtract(yId, mFloatId, positionId, 1);\n    writeCompositeExtract(zId, mFloatId, positionId, 2);\n    writeCompositeExtract(wId, mFloatId, positionId, 3);\n\n    uint32_t rotatedXId \u003d 0;\n    uint32_t rotatedYId \u003d 0;\n    preRotateXY(xId, yId, \u0026rotatedXId, \u0026rotatedYId);\n\n    writeCompositeConstruct(rotatedPositionId, mVec4Id, {rotatedXId, rotatedYId, zId, wId});\n    writeStore(positionPointerId, rotatedPositionId);\n\nwhich is dramatically simpler than the code required to generate all these in the translator and handling of specialization constants.\n\n---\n\nLet me paint the bigger picture. First, see the next change in this chain. With a simple:\n\n    writeFAdd(zPlusWId, mFloatId, zId, wId);\n    writeFMul(*correctedZIdOut, mFloatId, zPlusWId, mFloatHalfId);\n\nit\u0027s solving the z transformation problem, which would have otherwise needed even more translator code and specialization constants (especially after VK_EXT_depth_clip_control is done).\n\nMost importantly, I soon need to move transform feedback related code generation to SPIR-V for multiple reasons (early compilation of shaders, faster compilation by moving to SPIR-V generation by the translator, reducing memory by not having to store shader sources etc). Currently, we use a macro (@@ XFB-OUT @@) that gets replaced in the code at the right spot. Without the macro (because we don\u0027t want to modify the source anymore), finding the \"right spot\" itself is a challenge.\n\nOn the other hand, handling gl_Position changes in SPIR-V has the benefit that all these can be done in the same spot, in correct order, and share SPIR-V code:\n\n- Before end of main() or before EmitVertex():\n * Generate xfb related code for gl_Position\n * Generate rotation correction for gl_Position\n * Generate z correction for gl_Position\n\nAnd finally, note that every Vulkan driver does everything it needs to do in SPIR-V (or lower level). It\u0027s not really any less maintainable than our translator code.\n\n---\n\nI concede that doing the rotation stuff for FS is better left under spec consts.",
      "parentUuid": "afb376b1_bfd01813",
      "revId": "88e2be891c38fbaa80e3fcad911b54ad34749658",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "816dfcaa_740ce1a4",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1392020
      },
      "writtenOn": "2020-12-22T19:41:06Z",
      "side": 1,
      "message": "That is also the exact point argues the other way. Its the chain of CLs that will pile more and more onto spir-v transform, if we pick this direction. The question to ask is if the follow on changes can do in shader instead (for the same reason)? Can you implement XFB in shader and controlled by specialization constant as well? No doubt you are one of the top experts on spir-v, but most people won\u0027t really able to decode it easily. So unless there is material runtime perf benefit, I would vote for modification at GLSL level.",
      "parentUuid": "71990f0a_f4208f2a",
      "revId": "88e2be891c38fbaa80e3fcad911b54ad34749658",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c00542f9_25d75e76",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2020-12-22T21:01:13Z",
      "side": 1,
      "message": "Not with the emulation path for transform feedback, at least.\n\nLet me clarify more how the future looks like around here. The translator will at some point (soonish) generate SPIR-V directly from the AST. So we have two possibilities:\n\n1. Fewer transforms in AST, more transforms in SPIR-V\n2. More transforms in AST, fewer transforms in SPIR-V\n\n**There will no longer be an intermediary source code to look at for debugging either way.**\n\nWith option 1, you can see the SPIR-V before and after transformation. That would be the tool to use for debugging pre-rotation for example. With option 2, you would need to look at the AST for the same purpose. The AST is also assembly-like (there\u0027s a node for every little thing), so in terms of complexity is not that different from SPIR-V. Except you can easily dump SPIR-V and look at text (instead of looking at the AST with a debugger and navigating nodes who are all of the base-class pointer type) and it has a spec you can refer to understand it (unlike the AST).\n\nKnowing that you won\u0027t have source code post-translate to look at, do you still believe it\u0027s easier to debug transformations on the AST rather than SPIR-V?",
      "parentUuid": "816dfcaa_740ce1a4",
      "revId": "88e2be891c38fbaa80e3fcad911b54ad34749658",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "44aaec51_fcaa24f4",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1290487
      },
      "writtenOn": "2020-12-22T21:18:34Z",
      "side": 1,
      "message": "\u003e **There will no longer be an intermediary source code to look at for debugging either way.**\n\nGoing to Charlie\u0027s point, what is the motivation for this direction?  Is it for performance reasons?",
      "parentUuid": "c00542f9_25d75e76",
      "revId": "88e2be891c38fbaa80e3fcad911b54ad34749658",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c2b19cc0_bfb38ca8",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1300114
      },
      "writtenOn": "2020-12-22T21:44:19Z",
      "side": 1,
      "message": "Charlie\u0027s point is not on the direction you quoted, but I\u0027ll answer both.\n\nFor this particular set of changes: In the short term, conformance. This change is fixing bugs. In the long term, maintainability in conjunction with the other work (yeap, despite Charlie\u0027s and Tim\u0027s comments, this is more maintainable than AST changes IMO, especially when there\u0027s no intermediary readable GLSL to look at).\n\nRegarding AST to SPIR-V translation, there are numerous reasons:\n\n1. The double-compilation (going through ANGLE\u0027s translator, to source code and then again to glslang) is costly.\n - This has significant performance downsides which shows on low-end hardware like Fuchsia, but I recall another partner had also expressed concern\n - Bundling glslang with ANGLE significantly increases the binary footprint, which again hurts especially on embedded devices like Fuchsia.\n2. Despite my previous efforts to speed up glslang\u0027s warm up time for ANGLE, it is still significant, leading to a start up delay.\n - Removing dependency to glslang would also mean reverting my changes there and reducing clutter in glslang\n3. Arguably the most complex part of the SPIR-V transformer is its discovery of SPIR-V ids corresponding to shader variables.\n - Generating SPIR-V directly by ANGLE means the IDs can be remembered and forwarded to the transformer, significantly cleaning the SPIR-V transformer up\n - All the string-keyed maps revolving around the SPIR-V transformer can become integer-keyed",
      "parentUuid": "44aaec51_fcaa24f4",
      "revId": "88e2be891c38fbaa80e3fcad911b54ad34749658",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}